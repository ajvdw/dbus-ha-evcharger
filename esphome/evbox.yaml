esphome:
  name: my_device
  includes:
    - evbox.h

# Enable API
api:
  services:
    - service: set_evbox_current
      variables:
        current: float
      then:
        - lambda: |-
            id(my_evbox)->set_current(current);
    
    - service: get_evbox_status
      then:
        - logger.log:
            format: "L1: %.1fA, L2: %.1fA, L3: %.1fA, Energy: %.2f kWh"
            args: 
              - id(l1_current).state
              - id(l2_current).state
              - id(l3_current).state
              - id(total_energy).state

# Enable web server for HTTP endpoints
web_server:
  port: 80
  version: 2
  include_internal: true
  
uart:
  id: uart_bus
  tx_pin: GPIO1
  rx_pin: GPIO3
  baud_rate: 9600

evbox:
  id: my_evbox
  uart_id: uart_bus
  flow_control_pin: GPIO4

sensor:
  - platform: custom
    lambda: |-
      auto evbox = new evbox::EVBox();
      App.register_component(evbox);
      return {evbox->l1_current_sensor_, evbox->l2_current_sensor_, 
              evbox->l3_current_sensor_, evbox->total_energy_sensor_};
    sensors:
      - name: "L1 Current"
        id: l1_current
        unit_of_measurement: "A"
        accuracy_decimals: 1
        device_class: current
        state_class: measurement
        
      - name: "L2 Current"
        id: l2_current
        unit_of_measurement: "A"
        accuracy_decimals: 1
        device_class: current
        state_class: measurement
        
      - name: "L3 Current"
        id: l3_current
        unit_of_measurement: "A"
        accuracy_decimals: 1
        device_class: current
        state_class: measurement
        
      - name: "Total Energy"
        id: total_energy
        unit_of_measurement: "kWh"
        accuracy_decimals: 2
        device_class: energy
        state_class: total_increasing

# Custom text sensor with combined JSON
text_sensor:
  - platform: template
    name: "EVBox Status JSON"
    id: evbox_status_json
    lambda: |-
      char buffer[256];
      snprintf(buffer, sizeof(buffer), 
               "{\"l1_current\": %.1f, \"l2_current\": %.1f, \"l3_current\": %.1f, \"total_energy\": %.2f}",
               id(l1_current).state,
               id(l2_current).state,
               id(l3_current).state,
               id(total_energy).state);
      return {buffer};
    update_interval: 5s

# Number component to set current
number:
  - platform: template
    name: "Charging Current"
    min_value: 6
    max_value: 32
    step: 1
    unit_of_measurement: "A"
    mode: slider
    optimistic: true
    set_action:
      then:
        - lambda: |-
            id(my_evbox)->set_current(x);

# Example buttons
button:
  - platform: template
    name: "Set Current to 16A"
    on_press:
      then:
        - lambda: |-
            id(my_evbox)->set_current(16.0);
            
  - platform: template
    name: "Set Current to 32A"
    on_press:
      then:
        - lambda: |-
            id(my_evbox)->set_current(32.0);
